# Plan 06-01: Report Data Models & Migration

**Phase:** 6 - Report Core
**Plan:** 01 of 6
**Focus:** Backend database schema for reports

---

## Objective

Extend the Report model and create supporting models to store report data in a structured way:
- Template snapshot for historical consistency
- Info field values (project metadata)
- Checklist responses with optional comments

---

## Prerequisites

- Phase 5 complete (Template, TemplateSection, TemplateField, TemplateInfoField models exist)
- Database running with migrations up to 004

---

## Tasks

### Task 1: Extend Report Model

**File:** `backend/app/models/report.py`

Update the Report model:
- Remove `data_json` (will be replaced by structured models)
- Add `template_snapshot` (JSONB) - frozen template at creation
- Add `started_at` (timestamp, nullable)
- Add `completed_at` (timestamp, nullable)
- Add relationship to info values and checklist responses

```python
from sqlalchemy.dialects.postgresql import JSONB

class Report(Base):
    __tablename__ = "reports"

    title: Mapped[str] = mapped_column(String(255), nullable=False)
    status: Mapped[str] = mapped_column(
        String(50), nullable=False, default="draft", index=True
    )
    location: Mapped[str | None] = mapped_column(Text, nullable=True)

    # Template snapshot - frozen copy at report creation
    template_snapshot: Mapped[dict] = mapped_column(JSONB, nullable=False)

    # Lifecycle timestamps
    started_at: Mapped[datetime | None] = mapped_column(nullable=True)
    completed_at: Mapped[datetime | None] = mapped_column(nullable=True)

    # Foreign keys
    template_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("templates.id", ondelete="RESTRICT"), nullable=False, index=True
    )
    project_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("projects.id", ondelete="RESTRICT"), nullable=False, index=True
    )
    user_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("users.id", ondelete="RESTRICT"), nullable=False, index=True
    )

    # Relationships
    info_values: Mapped[list["ReportInfoValue"]] = relationship(
        back_populates="report", cascade="all, delete-orphan"
    )
    checklist_responses: Mapped[list["ReportChecklistResponse"]] = relationship(
        back_populates="report", cascade="all, delete-orphan"
    )
```

---

### Task 2: Create ReportInfoValue Model

**File:** `backend/app/models/report_info_value.py`

Stores filled values for each info field in a report.

```python
import uuid
from sqlalchemy import ForeignKey, String, Text
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.models.simple_base import SimpleBase

class ReportInfoValue(SimpleBase):
    """Stores a single info field value for a report."""

    __tablename__ = "report_info_values"

    # Foreign keys
    report_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("reports.id", ondelete="CASCADE"), nullable=False, index=True
    )
    info_field_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("template_info_fields.id", ondelete="SET NULL"), nullable=True
    )

    # Denormalized for snapshot (field may be deleted later)
    field_label: Mapped[str] = mapped_column(String(255), nullable=False)
    field_type: Mapped[str] = mapped_column(String(50), nullable=False)

    # The actual value
    value: Mapped[str | None] = mapped_column(Text, nullable=True)

    # Relationships
    report: Mapped["Report"] = relationship(back_populates="info_values")
```

---

### Task 3: Create ReportChecklistResponse Model

**File:** `backend/app/models/report_checklist_response.py`

Stores the response for each checklist field.

```python
import uuid
from sqlalchemy import ForeignKey, String, Text
from sqlalchemy.dialects.postgresql import JSONB
from sqlalchemy.orm import Mapped, mapped_column, relationship
from app.models.simple_base import SimpleBase

class ReportChecklistResponse(SimpleBase):
    """Stores a single checklist field response for a report."""

    __tablename__ = "report_checklist_responses"

    # Foreign keys
    report_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("reports.id", ondelete="CASCADE"), nullable=False, index=True
    )
    section_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("template_sections.id", ondelete="SET NULL"), nullable=True
    )
    field_id: Mapped[uuid.UUID] = mapped_column(
        ForeignKey("template_fields.id", ondelete="SET NULL"), nullable=True
    )

    # Denormalized for snapshot
    section_name: Mapped[str] = mapped_column(String(255), nullable=False)
    field_label: Mapped[str] = mapped_column(String(500), nullable=False)
    field_type: Mapped[str] = mapped_column(String(50), nullable=False)
    field_options: Mapped[str | None] = mapped_column(Text, nullable=True)

    # The actual response
    response_value: Mapped[str | None] = mapped_column(Text, nullable=True)
    comment: Mapped[str | None] = mapped_column(Text, nullable=True)

    # Photo references (array of {photo_id, url, caption})
    photos: Mapped[dict | None] = mapped_column(JSONB, nullable=True, default=list)

    # Relationships
    report: Mapped["Report"] = relationship(back_populates="checklist_responses")
```

---

### Task 4: Update Models __init__.py

**File:** `backend/app/models/__init__.py`

Add exports for new models.

---

### Task 5: Create Pydantic Schemas

**File:** `backend/app/schemas/report.py`

```python
from datetime import datetime
from uuid import UUID
from pydantic import BaseModel, Field

class ReportStatus:
    DRAFT = "draft"
    IN_PROGRESS = "in_progress"
    COMPLETED = "completed"
    ARCHIVED = "archived"

class InfoValueCreate(BaseModel):
    info_field_id: UUID | None = None
    field_label: str
    field_type: str
    value: str | None = None

class InfoValueResponse(InfoValueCreate):
    id: UUID
    report_id: UUID
    created_at: datetime

class ChecklistResponseCreate(BaseModel):
    section_id: UUID | None = None
    field_id: UUID | None = None
    section_name: str
    field_label: str
    field_type: str
    field_options: str | None = None
    response_value: str | None = None
    comment: str | None = None
    photos: list[dict] = Field(default_factory=list)

class ChecklistResponseResponse(ChecklistResponseCreate):
    id: UUID
    report_id: UUID
    created_at: datetime

class ReportCreate(BaseModel):
    template_id: UUID
    project_id: UUID
    title: str = Field(..., min_length=1, max_length=255)
    location: str | None = None

class ReportUpdate(BaseModel):
    title: str | None = None
    location: str | None = None
    status: str | None = None
    info_values: list[InfoValueCreate] | None = None
    checklist_responses: list[ChecklistResponseCreate] | None = None

class ReportResponse(BaseModel):
    id: UUID
    tenant_id: UUID
    template_id: UUID
    project_id: UUID
    user_id: UUID
    title: str
    status: str
    location: str | None
    template_snapshot: dict
    started_at: datetime | None
    completed_at: datetime | None
    created_at: datetime
    updated_at: datetime

class ReportDetailResponse(ReportResponse):
    info_values: list[InfoValueResponse]
    checklist_responses: list[ChecklistResponseResponse]

class ReportListResponse(BaseModel):
    reports: list[ReportResponse]
    total: int
```

---

### Task 6: Create Alembic Migration

**File:** `backend/alembic/versions/20260202_005_report_structured_data.py`

Migration to:
1. Add `template_snapshot`, `started_at`, `completed_at` to reports
2. Remove `data_json` from reports
3. Create `report_info_values` table
4. Create `report_checklist_responses` table

---

## Success Criteria

- [ ] Report model has template_snapshot (JSONB), started_at, completed_at
- [ ] ReportInfoValue model created with proper fields
- [ ] ReportChecklistResponse model created with photos JSONB
- [ ] Both new models use SimpleBase (no tenant_id, cascade delete)
- [ ] Models exported in __init__.py
- [ ] Pydantic schemas cover all CRUD operations
- [ ] Alembic migration runs successfully
- [ ] TypeScript compiles without errors

---

## Commit Message

```
feat(6): report data models and migration

- Extend Report with template_snapshot, started_at, completed_at
- Add ReportInfoValue for storing info field values
- Add ReportChecklistResponse for checklist answers with photos
- Create migration 005 for new schema
- Add Pydantic schemas for report CRUD
```
