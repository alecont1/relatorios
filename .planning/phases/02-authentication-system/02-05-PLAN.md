---
phase: 02-authentication-system
plan: 05
type: execute
wave: 2
depends_on: ["02-04"]
files_modified:
  - frontend/src/features/auth/schemas.ts
  - frontend/src/features/auth/components/PasswordInput.tsx
  - frontend/src/features/auth/components/LoginForm.tsx
  - frontend/src/pages/LoginPage.tsx
  - frontend/src/pages/UnauthorizedPage.tsx
  - frontend/src/App.tsx
autonomous: true

must_haves:
  truths:
    - "Login form submits email and password to /api/v1/auth/login"
    - "Login form shows specific error messages from backend"
    - "Password field has visibility toggle with eye icon"
    - "Successful login redirects to intended destination or dashboard"
    - "LoginPage is accessible at /login route"
    - "UnauthorizedPage shows access denied message"
  artifacts:
    - path: "frontend/src/features/auth/components/LoginForm.tsx"
      provides: "Login form with React Hook Form and Zod validation"
      exports: ["LoginForm"]
    - path: "frontend/src/features/auth/components/PasswordInput.tsx"
      provides: "Password input with visibility toggle"
      exports: ["PasswordInput"]
    - path: "frontend/src/pages/LoginPage.tsx"
      provides: "Login page layout"
      exports: ["LoginPage"]
  key_links:
    - from: "frontend/src/features/auth/components/LoginForm.tsx"
      to: "frontend/src/features/auth/api.ts"
      via: "useLogin mutation hook"
      pattern: "useLogin"
    - from: "frontend/src/App.tsx"
      to: "frontend/src/pages/LoginPage.tsx"
      via: "React Router route"
      pattern: "path.*login"
---

<objective>
Create the login UI: login form with React Hook Form, password visibility toggle, and Zod validation. Integrate with auth API and routing.

Purpose: Enable users to log in to the application (AUTH-01). Mobile-friendly design with eye icon for password visibility per CONTEXT.md.
Output: Working login page at /login with form validation and error handling.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-authentication-system/02-CONTEXT.md
@.planning/phases/02-authentication-system/02-RESEARCH.md

From CONTEXT.md:
- Password visibility toggle with eye icon - important for mobile users
- Specific error messages: "Email nao encontrado" or "Senha incorreta"
- Login identifier: email (not username)

From 02-04-PLAN:
- useLogin hook from features/auth/api.ts
- useAuthStore from features/auth/store.ts
- Lucide icons installed (Eye, EyeOff)

Existing:
- React Hook Form + Zod already installed
- Tailwind CSS v4 configured
- React Router 6.28 configured
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create login schemas and PasswordInput component</name>
  <files>
    frontend/src/features/auth/schemas.ts
    frontend/src/features/auth/components/PasswordInput.tsx
  </files>
  <action>
    1. Create frontend/src/features/auth/schemas.ts:
       ```typescript
       import { z } from 'zod';

       /**
        * Login form validation schema.
        */
       export const loginSchema = z.object({
         email: z
           .string()
           .min(1, 'Email e obrigatorio')
           .email('Email invalido'),
         password: z
           .string()
           .min(1, 'Senha e obrigatoria'),
       });

       export type LoginFormData = z.infer<typeof loginSchema>;

       /**
        * Strong password validation schema (for user creation).
        * Requirements: 8+ chars, uppercase, number, special character.
        */
       export const strongPasswordSchema = z
         .string()
         .min(8, 'Senha deve ter no minimo 8 caracteres')
         .regex(/[A-Z]/, 'Senha deve conter pelo menos uma letra maiuscula')
         .regex(/[0-9]/, 'Senha deve conter pelo menos um numero')
         .regex(
           /[!@#$%^&*(),.?":{}|<>]/,
           'Senha deve conter pelo menos um caractere especial'
         );

       /**
        * User creation form schema.
        */
       export const createUserSchema = z.object({
         email: z.string().email('Email invalido'),
         full_name: z
           .string()
           .min(2, 'Nome deve ter no minimo 2 caracteres')
           .max(255, 'Nome muito longo'),
         password: strongPasswordSchema,
         role: z.enum(['user', 'manager', 'admin'], {
           errorMap: () => ({ message: 'Selecione um cargo valido' }),
         }),
       });

       export type CreateUserFormData = z.infer<typeof createUserSchema>;
       ```

    2. Create frontend/src/features/auth/components/PasswordInput.tsx:
       ```typescript
       import { forwardRef, useState } from 'react';
       import { Eye, EyeOff } from 'lucide-react';

       interface PasswordInputProps
         extends React.InputHTMLAttributes<HTMLInputElement> {
         error?: string;
         label?: string;
       }

       /**
        * Password input with visibility toggle.
        *
        * Features:
        * - Eye icon to show/hide password
        * - Mobile-friendly tap target (min 44px)
        * - Accessible labels and aria attributes
        */
       export const PasswordInput = forwardRef<HTMLInputElement, PasswordInputProps>(
         ({ error, label = 'Senha', className = '', id, ...props }, ref) => {
           const [showPassword, setShowPassword] = useState(false);
           const inputId = id || 'password';

           return (
             <div className="w-full">
               {label && (
                 <label
                   htmlFor={inputId}
                   className="mb-1 block text-sm font-medium text-gray-700"
                 >
                   {label}
                 </label>
               )}
               <div className="relative">
                 <input
                   ref={ref}
                   type={showPassword ? 'text' : 'password'}
                   id={inputId}
                   className={`
                     block w-full rounded-lg border border-gray-300 px-4 py-3 pr-12
                     text-base placeholder-gray-400
                     focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20
                     disabled:bg-gray-100 disabled:cursor-not-allowed
                     ${error ? 'border-red-500 focus:border-red-500 focus:ring-red-500/20' : ''}
                     ${className}
                   `}
                   aria-invalid={error ? 'true' : 'false'}
                   aria-describedby={error ? `${inputId}-error` : undefined}
                   {...props}
                 />
                 <button
                   type="button"
                   onClick={() => setShowPassword(!showPassword)}
                   className="
                     absolute inset-y-0 right-0 flex items-center pr-3
                     min-w-[44px] min-h-[44px] justify-center
                     text-gray-500 hover:text-gray-700
                     focus:outline-none focus:text-blue-600
                   "
                   aria-label={showPassword ? 'Ocultar senha' : 'Mostrar senha'}
                   tabIndex={-1}
                 >
                   {showPassword ? (
                     <EyeOff className="h-5 w-5" aria-hidden="true" />
                   ) : (
                     <Eye className="h-5 w-5" aria-hidden="true" />
                   )}
                 </button>
               </div>
               {error && (
                 <p
                   id={`${inputId}-error`}
                   className="mt-1 text-sm text-red-600"
                   role="alert"
                 >
                   {error}
                 </p>
               )}
             </div>
           );
         }
       );

       PasswordInput.displayName = 'PasswordInput';
       ```
  </action>
  <verify>
    cd frontend && npx tsc --noEmit src/features/auth/schemas.ts src/features/auth/components/PasswordInput.tsx
  </verify>
  <done>Login schemas and PasswordInput component with visibility toggle created</done>
</task>

<task type="auto">
  <name>Task 2: Create LoginForm component</name>
  <files>
    frontend/src/features/auth/components/LoginForm.tsx
    frontend/src/features/auth/components/index.ts
  </files>
  <action>
    1. Create frontend/src/features/auth/components/LoginForm.tsx:
       ```typescript
       import { useForm } from 'react-hook-form';
       import { zodResolver } from '@hookform/resolvers/zod';
       import { useNavigate, useLocation } from 'react-router-dom';
       import { Loader2 } from 'lucide-react';
       import { useLogin } from '../api';
       import { loginSchema, type LoginFormData } from '../schemas';
       import { PasswordInput } from './PasswordInput';

       /**
        * Login form component.
        *
        * Features:
        * - React Hook Form with Zod validation
        * - Shows specific backend error messages
        * - Redirects to intended page after login
        * - Loading state during submission
        */
       export function LoginForm() {
         const navigate = useNavigate();
         const location = useLocation();
         const login = useLogin();

         // Get redirect destination from location state
         const from = (location.state as { from?: Location })?.from?.pathname || '/';

         const {
           register,
           handleSubmit,
           formState: { errors, isSubmitting },
           setError,
         } = useForm<LoginFormData>({
           resolver: zodResolver(loginSchema),
           defaultValues: {
             email: '',
             password: '',
           },
         });

         const onSubmit = async (data: LoginFormData) => {
           try {
             await login.mutateAsync(data);
             // Redirect to intended destination
             navigate(from, { replace: true });
           } catch (error: unknown) {
             // Extract error message from response
             const axiosError = error as {
               response?: { data?: { detail?: string } };
             };
             const message =
               axiosError.response?.data?.detail || 'Erro ao fazer login';

             // Show error in form
             setError('root', { message });
           }
         };

         return (
           <form
             onSubmit={handleSubmit(onSubmit)}
             className="space-y-6"
             noValidate
           >
             {/* Email field */}
             <div>
               <label
                 htmlFor="email"
                 className="mb-1 block text-sm font-medium text-gray-700"
               >
                 Email
               </label>
               <input
                 {...register('email')}
                 type="email"
                 id="email"
                 autoComplete="email"
                 placeholder="seu@email.com"
                 className={`
                   block w-full rounded-lg border border-gray-300 px-4 py-3
                   text-base placeholder-gray-400
                   focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500/20
                   ${errors.email ? 'border-red-500 focus:border-red-500 focus:ring-red-500/20' : ''}
                 `}
                 aria-invalid={errors.email ? 'true' : 'false'}
                 aria-describedby={errors.email ? 'email-error' : undefined}
               />
               {errors.email && (
                 <p
                   id="email-error"
                   className="mt-1 text-sm text-red-600"
                   role="alert"
                 >
                   {errors.email.message}
                 </p>
               )}
             </div>

             {/* Password field */}
             <PasswordInput
               {...register('password')}
               label="Senha"
               id="password"
               autoComplete="current-password"
               placeholder="Digite sua senha"
               error={errors.password?.message}
             />

             {/* Root error (backend errors) */}
             {errors.root && (
               <div
                 className="rounded-lg bg-red-50 p-4 text-sm text-red-700"
                 role="alert"
               >
                 {errors.root.message}
               </div>
             )}

             {/* Submit button */}
             <button
               type="submit"
               disabled={isSubmitting || login.isPending}
               className="
                 flex w-full items-center justify-center
                 rounded-lg bg-blue-600 px-4 py-3
                 text-base font-medium text-white
                 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2
                 disabled:cursor-not-allowed disabled:opacity-50
                 transition-colors
               "
             >
               {(isSubmitting || login.isPending) ? (
                 <>
                   <Loader2 className="mr-2 h-5 w-5 animate-spin" />
                   Entrando...
                 </>
               ) : (
                 'Entrar'
               )}
             </button>
           </form>
         );
       }
       ```

    2. Create frontend/src/features/auth/components/index.ts:
       ```typescript
       export { ProtectedRoute } from './ProtectedRoute';
       export { PasswordInput } from './PasswordInput';
       export { LoginForm } from './LoginForm';
       ```

    3. Update frontend/src/features/auth/index.ts to include schemas:
       ```typescript
       export { useAuthStore } from './store';
       export { useLogin, useLogout, useRefreshToken } from './api';
       export { ProtectedRoute, PasswordInput, LoginForm } from './components';
       export { loginSchema, strongPasswordSchema, createUserSchema } from './schemas';
       export type {
         User,
         UserRole,
         AuthState,
         LoginRequest,
         LoginResponse,
       } from './types';
       export type { LoginFormData, CreateUserFormData } from './schemas';
       ```
  </action>
  <verify>
    cd frontend && npx tsc --noEmit src/features/auth/components/LoginForm.tsx
  </verify>
  <done>LoginForm component with validation and error handling created</done>
</task>

<task type="auto">
  <name>Task 3: Create login page and update routing</name>
  <files>
    frontend/src/pages/LoginPage.tsx
    frontend/src/pages/UnauthorizedPage.tsx
    frontend/src/pages/index.ts
    frontend/src/App.tsx
  </files>
  <action>
    1. Create frontend/src/pages/LoginPage.tsx:
       ```typescript
       import { Navigate } from 'react-router-dom';
       import { LoginForm, useAuthStore } from '@/features/auth';

       /**
        * Login page.
        *
        * - Shows login form centered on page
        * - Redirects authenticated users to dashboard
        * - Mobile-friendly layout
        */
       export function LoginPage() {
         const { isAuthenticated, isLoading } = useAuthStore();

         // Redirect if already authenticated
         if (!isLoading && isAuthenticated) {
           return <Navigate to="/" replace />;
         }

         return (
           <div className="flex min-h-screen flex-col items-center justify-center bg-gray-50 px-4 py-12 sm:px-6 lg:px-8">
             <div className="w-full max-w-md">
               {/* Logo/Header */}
               <div className="mb-8 text-center">
                 <h1 className="text-3xl font-bold text-gray-900">
                   SmartHand
                 </h1>
                 <p className="mt-2 text-sm text-gray-600">
                   Entre com suas credenciais para acessar o sistema
                 </p>
               </div>

               {/* Login card */}
               <div className="rounded-xl bg-white p-8 shadow-lg">
                 <LoginForm />
               </div>

               {/* Footer */}
               <p className="mt-6 text-center text-xs text-gray-500">
                 Nao tem acesso? Entre em contato com seu administrador.
               </p>
             </div>
           </div>
         );
       }
       ```

    2. Create frontend/src/pages/UnauthorizedPage.tsx:
       ```typescript
       import { useNavigate } from 'react-router-dom';
       import { ShieldX } from 'lucide-react';

       /**
        * Unauthorized access page.
        *
        * Shown when user tries to access a page their role doesn't allow.
        */
       export function UnauthorizedPage() {
         const navigate = useNavigate();

         return (
           <div className="flex min-h-screen flex-col items-center justify-center bg-gray-50 px-4">
             <div className="text-center">
               <ShieldX className="mx-auto h-16 w-16 text-red-500" />
               <h1 className="mt-4 text-2xl font-bold text-gray-900">
                 Acesso Negado
               </h1>
               <p className="mt-2 text-gray-600">
                 Voce nao tem permissao para acessar esta pagina.
               </p>
               <button
                 onClick={() => navigate(-1)}
                 className="
                   mt-6 inline-flex items-center rounded-lg
                   bg-blue-600 px-4 py-2 text-white
                   hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500
                 "
               >
                 Voltar
               </button>
             </div>
           </div>
         );
       }
       ```

    3. Create frontend/src/pages/index.ts:
       ```typescript
       export { LoginPage } from './LoginPage';
       export { UnauthorizedPage } from './UnauthorizedPage';
       ```

    4. Update frontend/src/App.tsx to add routes:
       ```typescript
       import { BrowserRouter, Routes, Route } from 'react-router-dom';
       import { QueryClientProvider } from '@tanstack/react-query';
       import { queryClient } from '@/lib/queryClient';
       import { LoginPage, UnauthorizedPage } from '@/pages';
       import { ProtectedRoute } from '@/features/auth';
       import { useEffect } from 'react';
       import { useRefreshToken, useAuthStore } from '@/features/auth';

       function AuthInitializer({ children }: { children: React.ReactNode }) {
         const { isAuthenticated, accessToken, isLoading } = useAuthStore();
         const refresh = useRefreshToken();

         useEffect(() => {
           // If we have persisted auth but no token, try to refresh
           if (isAuthenticated && !accessToken && isLoading) {
             refresh.mutate();
           } else if (!isAuthenticated && isLoading) {
             // No persisted auth, just clear loading
             useAuthStore.getState().setLoading(false);
           }
         }, [isAuthenticated, accessToken, isLoading, refresh]);

         return <>{children}</>;
       }

       function DashboardPage() {
         const { user } = useAuthStore();
         return (
           <div className="min-h-screen bg-gray-50 p-8">
             <h1 className="text-2xl font-bold">Dashboard</h1>
             <p className="mt-2 text-gray-600">
               Bem-vindo, {user?.full_name}!
             </p>
             <p className="text-sm text-gray-500">
               Cargo: {user?.role}
             </p>
           </div>
         );
       }

       function App() {
         return (
           <QueryClientProvider client={queryClient}>
             <BrowserRouter>
               <AuthInitializer>
                 <Routes>
                   {/* Public routes */}
                   <Route path="/login" element={<LoginPage />} />
                   <Route path="/unauthorized" element={<UnauthorizedPage />} />

                   {/* Protected routes */}
                   <Route
                     path="/"
                     element={
                       <ProtectedRoute>
                         <DashboardPage />
                       </ProtectedRoute>
                     }
                   />

                   {/* Catch-all redirect to login */}
                   <Route path="*" element={<LoginPage />} />
                 </Routes>
               </AuthInitializer>
             </BrowserRouter>
           </QueryClientProvider>
         );
       }

       export default App;
       ```
  </action>
  <verify>
    cd frontend && npm run type-check
    # Should pass type checking
  </verify>
  <done>Login page and routing configured with protected routes</done>
</task>

</tasks>

<verification>
1. npm run type-check passes without errors
2. npm run dev starts the dev server
3. Navigating to /login shows the login form
4. Submitting invalid email shows validation error
5. Submitting with wrong credentials shows backend error message
6. Successful login redirects to dashboard
7. Navigating to / without auth redirects to /login
8. Password field has working eye icon toggle
</verification>

<success_criteria>
- LoginPage at /login with centered form
- LoginForm uses React Hook Form with Zod validation
- PasswordInput has visibility toggle with Eye/EyeOff icons
- Backend errors displayed in form (specific messages)
- Successful login redirects to intended page
- UnauthorizedPage at /unauthorized
- ProtectedRoute guards / route
- AuthInitializer attempts token refresh on load
- All text in Portuguese
- Mobile-friendly styling (large tap targets, readable on small screens)
</success_criteria>

<output>
After completion, create `.planning/phases/02-authentication-system/02-05-SUMMARY.md`
</output>
