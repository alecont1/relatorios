---
phase: 01-setup-infrastructure
plan: 05
type: execute
wave: 3
depends_on: ["01-01", "01-02", "01-03"]
files_modified:
  - frontend/vercel.json
  - backend/Procfile
  - backend/railway.json
  - .github/workflows/ci.yml
  - .gitignore
  - README.md
autonomous: false
user_setup:
  - service: vercel
    why: "Frontend hosting with preview deployments"
    env_vars:
      - name: VITE_API_URL
        source: "Railway backend URL (available after Railway deploy)"
    dashboard_config:
      - task: "Import Git repository"
        location: "Vercel Dashboard -> New Project -> Import"
      - task: "Set root directory to frontend/"
        location: "Project Settings -> General -> Root Directory"
  - service: railway
    why: "Backend hosting with PostgreSQL and Redis"
    env_vars:
      - name: DATABASE_URL
        source: "Railway auto-provisions PostgreSQL, provides this variable"
      - name: REDIS_URL
        source: "Railway auto-provisions Redis, provides this variable"
    dashboard_config:
      - task: "Create new project from GitHub repo"
        location: "Railway Dashboard -> New Project"
      - task: "Add PostgreSQL service"
        location: "Project -> New -> Database -> PostgreSQL"
      - task: "Add Redis service"
        location: "Project -> New -> Database -> Redis"
      - task: "Set root directory to backend/"
        location: "Service Settings -> Root Directory"
  - service: cloudflare-r2
    why: "Object storage for photos"
    env_vars:
      - name: R2_ENDPOINT_URL
        source: "Cloudflare Dashboard -> R2 -> Account Details -> S3 API endpoint"
      - name: R2_ACCESS_KEY_ID
        source: "Cloudflare Dashboard -> R2 -> Manage R2 API Tokens -> Create API Token"
      - name: R2_SECRET_ACCESS_KEY
        source: "Same token creation as above"
    dashboard_config:
      - task: "Create R2 bucket named 'smarthand-photos'"
        location: "Cloudflare Dashboard -> R2 -> Create bucket"

must_haves:
  truths:
    - "GitHub Actions CI runs on push to main and on pull requests"
    - "CI installs dependencies and runs type-check for frontend"
    - "CI installs dependencies and runs pytest for backend"
    - "CI tests the full stack including Alembic migrations"
    - "Vercel configuration specifies frontend/ as build root"
    - "Railway configuration specifies backend/ as service root with correct start command"
    - "Redis instance is provisioned and accessible from backend"
  artifacts:
    - path: ".github/workflows/ci.yml"
      provides: "CI/CD pipeline definition"
      contains: "pytest"
    - path: "frontend/vercel.json"
      provides: "Vercel deployment configuration"
      contains: "routes"
    - path: "backend/railway.json"
      provides: "Railway deployment configuration"
      contains: "startCommand"
    - path: "backend/Procfile"
      provides: "Process definition for Railway"
      contains: "uvicorn"
    - path: ".gitignore"
      provides: "Git ignore rules for monorepo"
      contains: "node_modules"
  key_links:
    - from: ".github/workflows/ci.yml"
      to: "frontend/package.json"
      via: "npm ci && npm run build in frontend/"
      pattern: "working-directory.*frontend"
    - from: ".github/workflows/ci.yml"
      to: "backend/requirements.txt"
      via: "pip install && pytest in backend/"
      pattern: "working-directory.*backend"
---

<objective>
Configure deployment for Vercel (frontend), Railway (backend + DB + Redis), and GitHub Actions CI/CD pipeline.

Purpose: Enable automated testing and deployment so every push to main deploys both services.
Output: CI/CD workflow, Vercel config, Railway config, and deployment-ready project structure.

Note: This plan contains 3 tasks with human verification checkpoint. Considered splitting into separate configs (01-05) and CI/CD (01-06) plans, but kept unified since all tasks relate to deployment infrastructure setup and the checkpoint is a single verification gate at the end.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/01-setup-infrastructure/01-01-SUMMARY.md
@.planning/phases/01-setup-infrastructure/01-02-SUMMARY.md

Research findings (from planning context):
- Railway: Separate services for backend, PostgreSQL, Redis (NOT docker-compose)
- Vercel: VITE_ prefixed env vars, base './' for relative paths
- Monorepo: frontend/ and backend/ at project root
- Start with requirements.txt for Railway auto-detection
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create deployment configurations</name>
  <files>
    frontend/vercel.json
    backend/Procfile
    backend/railway.json
    .gitignore
  </files>
  <action>
    1. frontend/vercel.json:
       ```json
       {
         "framework": "vite",
         "buildCommand": "npm run build",
         "outputDirectory": "dist",
         "routes": [
           { "handle": "filesystem" },
           { "src": "/(.*)", "dest": "/index.html" }
         ]
       }
       ```
       The SPA fallback route ensures React Router works on refresh.

    2. backend/Procfile:
       ```
       web: uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000}
       worker: celery -A app.tasks.worker worker --loglevel=info
       ```

    3. backend/railway.json:
       ```json
       {
         "$schema": "https://railway.com/railway.schema.json",
         "build": {
           "builder": "NIXPACKS",
           "buildCommand": "pip install -r requirements.txt"
         },
         "deploy": {
           "startCommand": "uvicorn app.main:app --host 0.0.0.0 --port ${PORT:-8000}",
           "healthcheckPath": "/api/v1/health",
           "healthcheckTimeout": 30,
           "restartPolicyType": "ON_FAILURE",
           "restartPolicyMaxRetries": 3
         }
       }
       ```

    4. .gitignore (root level for monorepo):
       ```
       # Dependencies
       node_modules/
       __pycache__/
       *.pyc
       .venv/
       venv/

       # Build outputs
       dist/
       build/
       *.egg-info/

       # Environment
       .env
       .env.local
       .env.*.local

       # IDE
       .vscode/
       .idea/
       *.swp
       *.swo

       # OS
       .DS_Store
       Thumbs.db

       # Testing
       .coverage
       htmlcov/
       .pytest_cache/

       # Logs
       *.log
       ```
  </action>
  <verify>
    ls frontend/vercel.json backend/Procfile backend/railway.json .gitignore
    All files exist
  </verify>
  <done>Deployment configs created for Vercel (SPA), Railway (uvicorn + celery), and proper .gitignore</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow</name>
  <files>
    .github/workflows/ci.yml
  </files>
  <action>
    Create .github/workflows/ci.yml:

    ```yaml
    name: CI

    on:
      push:
        branches: [main]
      pull_request:
        branches: [main]

    jobs:
      frontend:
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: frontend
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-node@v4
            with:
              node-version: 20
              cache: 'npm'
              cache-dependency-path: frontend/package-lock.json
          - run: npm ci
          - run: npm run type-check
          - run: npm run build

      backend:
        runs-on: ubuntu-latest
        defaults:
          run:
            working-directory: backend
        steps:
          - uses: actions/checkout@v4
          - uses: actions/setup-python@v5
            with:
              python-version: '3.12'
              cache: 'pip'
              cache-dependency-path: backend/requirements.txt
          - run: pip install -r requirements.txt
          - run: python -m pytest tests/ -v
            env:
              DATABASE_URL: "sqlite+aiosqlite:///test.db"
              R2_ENDPOINT_URL: "https://test.r2.cloudflarestorage.com"
              R2_ACCESS_KEY_ID: "test"
              R2_SECRET_ACCESS_KEY: "test"
              R2_BUCKET_NAME: "test-bucket"
              REDIS_URL: "redis://localhost:6379/0"
    ```

    This runs frontend and backend checks in parallel.
    Backend uses SQLite for CI tests (no PostgreSQL service needed for unit tests).
  </action>
  <verify>
    cat .github/workflows/ci.yml | head -5
    Expected: "name: CI"
    Validate YAML syntax: python -c "import yaml; yaml.safe_load(open('.github/workflows/ci.yml'))"
  </verify>
  <done>CI pipeline runs type-check+build for frontend and pytest for backend on every push/PR to main</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Deployment configuration files for the complete infrastructure:
    - Vercel config for frontend SPA deployment
    - Railway config for backend API deployment
    - GitHub Actions CI pipeline for automated testing
    - Root .gitignore for monorepo
  </what-built>
  <how-to-verify>
    1. Review .github/workflows/ci.yml - confirm it tests both frontend and backend
    2. Review frontend/vercel.json - confirm SPA routing fallback
    3. Review backend/railway.json - confirm health check path matches actual endpoint
    4. Review backend/Procfile - confirm uvicorn command is correct
    5. Confirm .gitignore excludes .env files, node_modules, __pycache__

    External services setup (do after verification):
    - Create Vercel project pointing to this repo, set root to frontend/
    - Create Railway project with PostgreSQL + Redis services, set root to backend/
    - Create Cloudflare R2 bucket named "smarthand-photos"
    - Set environment variables in each platform
  </how-to-verify>
  <resume-signal>Type "approved" to proceed, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. All deployment config files exist and are valid JSON/YAML
2. CI workflow has both frontend and backend jobs
3. .gitignore covers all necessary patterns
4. Procfile has web and worker processes
5. Railway config has health check pointing to /api/v1/health
6. Vercel config has SPA fallback route
</verification>

<success_criteria>
- GitHub Actions CI runs frontend type-check + build
- GitHub Actions CI runs backend pytest
- Vercel config enables SPA routing
- Railway config uses uvicorn with PORT env var
- Procfile defines web and worker processes
- .gitignore properly excludes sensitive and generated files
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup-infrastructure/01-05-SUMMARY.md`
</output>
