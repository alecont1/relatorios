---
phase: 01-setup-infrastructure
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/requirements.txt
  - backend/app/__init__.py
  - backend/app/main.py
  - backend/app/core/__init__.py
  - backend/app/core/config.py
  - backend/app/core/database.py
  - backend/app/models/__init__.py
  - backend/app/models/base.py
  - backend/app/schemas/__init__.py
  - backend/app/api/__init__.py
  - backend/app/api/v1/__init__.py
  - backend/app/api/v1/routes/__init__.py
  - backend/app/api/v1/routes/health.py
  - backend/.env.example
autonomous: true

must_haves:
  truths:
    - "Running uvicorn app.main:app starts the server on port 8000"
    - "GET /health returns 200 with status ok and version"
    - "GET /docs shows FastAPI Swagger UI"
    - "Database connection succeeds with configured URL from environment variable"
    - "Frontend origin can make cross-origin requests via configured CORS"
  artifacts:
    - path: "backend/app/main.py"
      provides: "FastAPI application entry point"
      contains: "FastAPI"
    - path: "backend/app/core/config.py"
      provides: "Application settings via Pydantic BaseSettings"
      exports: ["settings"]
    - path: "backend/app/core/database.py"
      provides: "Async SQLAlchemy engine and session factory"
      exports: ["engine", "async_session", "get_db"]
    - path: "backend/app/models/base.py"
      provides: "SQLAlchemy declarative base with common columns"
      exports: ["Base"]
    - path: "backend/requirements.txt"
      provides: "Python dependencies for Railway auto-detection"
      contains: "fastapi"
  key_links:
    - from: "backend/app/main.py"
      to: "backend/app/api/v1/routes/health.py"
      via: "Router include"
      pattern: "include_router"
    - from: "backend/app/main.py"
      to: "backend/app/core/config.py"
      via: "Settings import for CORS origins"
      pattern: "settings\\.cors_origins"
    - from: "backend/app/core/database.py"
      to: "backend/app/core/config.py"
      via: "DATABASE_URL from settings"
      pattern: "settings\\.database_url"
---

<objective>
Initialize the SmartHand backend with FastAPI, async SQLAlchemy 2.0, and the module-functionality project structure.

Purpose: Establish the backend foundation with proper async patterns, configuration management, and API structure that all subsequent backend phases build upon.
Output: A working backend/ directory with FastAPI server, health endpoint, and database connection setup.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
Research findings (from planning context):
- Backend: async SQLAlchemy 2.0 with psycopg3, FastAPI 0.115+
- Backend structure: Module-functionality pattern (core/, models/, schemas/, api/v1/routes/, services/, tasks/)
- Railway: auto-detection via requirements.txt
- CORS: Use env var for origins, allow Vercel preview URLs
- Application-level tenant filtering for Phase 1 (RLS later)
- Start with requirements.txt (Railway auto-detection)

Database: PostgreSQL with PostGIS extension
Multi-tenant: tenant_id on all tables (application-level filtering)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create FastAPI project structure with configuration</name>
  <files>
    backend/requirements.txt
    backend/app/__init__.py
    backend/app/main.py
    backend/app/core/__init__.py
    backend/app/core/config.py
    backend/.env.example
  </files>
  <action>
    Create the backend/ directory at project root (C:\Users\xande\smarthand-reports\backend\).

    1. requirements.txt with pinned versions:
       - fastapi>=0.115.0
       - uvicorn[standard]>=0.30.0
       - sqlalchemy[asyncio]>=2.0.30
       - psycopg[binary,pool]>=3.1.18 (psycopg3 - async PostgreSQL driver)
       - alembic>=1.13.0
       - pydantic>=2.6.0
       - pydantic-settings>=2.2.0
       - python-dotenv>=1.0.0
       - boto3>=1.34.0 (for R2)
       - python-multipart>=0.0.9
       - celery[redis]>=5.3.0
       - redis>=5.0.0
       - weasyprint>=62.0
       - geoalchemy2>=0.15.0 (PostGIS)
       - httpx>=0.27.0 (for testing)
       - pytest>=8.0.0
       - pytest-asyncio>=0.23.0

    2. app/core/config.py using Pydantic BaseSettings:
       - class Settings(BaseSettings):
         - app_name: str = "SmartHand"
         - app_version: str = "0.1.0"
         - debug: bool = False
         - database_url: str (required, no default)
         - cors_origins: list[str] = ["http://localhost:5173"]
         - r2_endpoint_url: str = ""
         - r2_access_key_id: str = ""
         - r2_secret_access_key: str = ""
         - r2_bucket_name: str = "smarthand-photos"
         - redis_url: str = "redis://localhost:6379/0"
         - model_config with env_file=".env", env_file_encoding="utf-8"
       - Export: settings = Settings()

    3. app/main.py:
       - Create FastAPI app with title="SmartHand API", version from settings
       - Add CORSMiddleware with origins from settings.cors_origins
       - Include health router at prefix=""
       - Add lifespan async context manager (placeholder for DB init/cleanup)

    4. .env.example:
       - DATABASE_URL=postgresql+psycopg://user:password@localhost:5432/smarthand
       - CORS_ORIGINS=["http://localhost:5173"]
       - R2_ENDPOINT_URL=
       - R2_ACCESS_KEY_ID=
       - R2_SECRET_ACCESS_KEY=
       - R2_BUCKET_NAME=smarthand-photos
       - REDIS_URL=redis://localhost:6379/0
       - DEBUG=true

    5. app/__init__.py: empty file
       app/core/__init__.py: empty file
  </action>
  <verify>
    cd backend && pip install -r requirements.txt (or check syntax with pip install --dry-run)
    python -c "from app.core.config import settings; print('Config OK')" (with DATABASE_URL env var set)
  </verify>
  <done>FastAPI app starts, settings load from environment, CORS configured</done>
</task>

<task type="auto">
  <name>Task 2: Create database layer and API routes</name>
  <files>
    backend/app/core/database.py
    backend/app/models/__init__.py
    backend/app/models/base.py
    backend/app/schemas/__init__.py
    backend/app/api/__init__.py
    backend/app/api/v1/__init__.py
    backend/app/api/v1/routes/__init__.py
    backend/app/api/v1/routes/health.py
  </files>
  <action>
    1. app/core/database.py:
       - Create async engine: create_async_engine(settings.database_url, echo=settings.debug)
       - Create async_session factory: async_sessionmaker(engine, class_=AsyncSession, expire_on_commit=False)
       - Create get_db async generator dependency:
         ```python
         async def get_db() -> AsyncGenerator[AsyncSession, None]:
             async with async_session() as session:
                 try:
                     yield session
                     await session.commit()
                 except Exception:
                     await session.rollback()
                     raise
         ```

    2. app/models/base.py:
       - Import DeclarativeBase from sqlalchemy.orm
       - Create Base class with:
         - id: Mapped[uuid.UUID] = mapped_column(primary_key=True, default=uuid.uuid4)
         - tenant_id: Mapped[uuid.UUID] = mapped_column(index=True)
         - created_at: Mapped[datetime] = mapped_column(default=func.now())
         - updated_at: Mapped[datetime] = mapped_column(default=func.now(), onupdate=func.now())
       - This is the base for ALL models (multi-tenant from day one)

    3. app/api/v1/routes/health.py:
       - APIRouter with tag="health"
       - GET "/" returns {"status": "ok", "version": settings.app_version, "app": settings.app_name}
       - GET "/health" returns same (for load balancer checks)

    4. Create empty __init__.py for:
       - app/models/
       - app/schemas/
       - app/api/
       - app/api/v1/
       - app/api/v1/routes/

    5. Update app/main.py to include the health router:
       ```python
       from app.api.v1.routes.health import router as health_router
       app.include_router(health_router, prefix="/api/v1")
       ```
  </action>
  <verify>
    cd backend && DATABASE_URL="sqlite+aiosqlite:///test.db" uvicorn app.main:app --host 0.0.0.0 --port 8000 &
    sleep 2
    curl http://localhost:8000/api/v1/health
    Expected: {"status":"ok","version":"0.1.0","app":"SmartHand"}
    kill %1
  </verify>
  <done>Health endpoint returns 200, database session factory is configured, Base model has tenant_id/timestamps</done>
</task>

</tasks>

<verification>
1. `cd backend && pip install -r requirements.txt` succeeds
2. `uvicorn app.main:app` starts on port 8000
3. GET /api/v1/health returns {"status":"ok","version":"0.1.0","app":"SmartHand"}
4. GET /docs shows Swagger UI with health endpoint documented
5. No import errors when running the application
</verification>

<success_criteria>
- backend/requirements.txt lists all required packages
- FastAPI server starts without errors
- Health endpoint responds with correct JSON
- Settings load from environment variables
- CORS middleware is active
- Async SQLAlchemy engine and session factory are configured
- Base model includes id, tenant_id, created_at, updated_at
</success_criteria>

<output>
After completion, create `.planning/phases/01-setup-infrastructure/01-02-SUMMARY.md`
</output>
