---
phase: 05-template-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/models/template_info_field.py
  - backend/app/models/template_signature_field.py
  - backend/app/models/template_field.py
  - backend/app/models/template.py
  - backend/app/models/__init__.py
  - backend/alembic/versions/004_template_configuration.py
autonomous: true

must_haves:
  truths:
    - "TemplateInfoField model exists with label, field_type, options, required, order fields"
    - "TemplateSignatureField model exists with role_name, required, order fields"
    - "TemplateField model has photo_config, comment_config JSONB columns"
    - "Template model has relationships to info_fields and signature_fields"
    - "Database migration applies cleanly to add new tables and columns"
  artifacts:
    - path: "backend/app/models/template_info_field.py"
      provides: "TemplateInfoField SQLAlchemy model"
      min_lines: 30
    - path: "backend/app/models/template_signature_field.py"
      provides: "TemplateSignatureField SQLAlchemy model"
      min_lines: 25
    - path: "backend/alembic/versions/004_template_configuration.py"
      provides: "Alembic migration for Phase 5 schema changes"
      contains: "def upgrade"
  key_links:
    - from: "backend/app/models/template_info_field.py"
      to: "templates table"
      via: "ForeignKey template_id with CASCADE delete"
      pattern: 'ForeignKey.*templates.id.*ondelete.*CASCADE'
    - from: "backend/app/models/template_signature_field.py"
      to: "templates table"
      via: "ForeignKey template_id with CASCADE delete"
      pattern: 'ForeignKey.*templates.id.*ondelete.*CASCADE'
    - from: "backend/app/models/template.py"
      to: "info_fields and signature_fields"
      via: "SQLAlchemy relationships"
      pattern: 'relationship.*TemplateInfoField|TemplateSignatureField'
---

<objective>
Create database models for template configuration: TemplateInfoField (project metadata fields), TemplateSignatureField (signature requirements), and extend TemplateField with JSONB columns for photo/comment configuration.

Purpose: Enable storage of configurable template structure including info fields at template level, signature requirements, and field-level photo/comment settings.

Output: New SQLAlchemy models, updated Template model with relationships, Alembic migration.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-template-configuration/05-RESEARCH.md

# Key existing models to understand
@backend/app/models/template.py
@backend/app/models/template_field.py
@backend/app/models/simple_base.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplateInfoField and TemplateSignatureField models</name>
  <files>
    backend/app/models/template_info_field.py
    backend/app/models/template_signature_field.py
    backend/app/models/__init__.py
  </files>
  <action>
Create two new model files extending SimpleBase (no direct tenant_id, inherits isolation via Template):

**template_info_field.py:**
```python
class TemplateInfoField(SimpleBase):
    __tablename__ = "template_info_fields"

    template_id: UUID FK to templates.id with CASCADE delete
    label: String(255), not null
    field_type: String(50), not null - values: "text", "date", "select"
    options: Text, nullable - JSON array for select options
    required: Boolean, default True
    order: Integer, not null

    Relationship: template back_populates="info_fields"
```

**template_signature_field.py:**
```python
class TemplateSignatureField(SimpleBase):
    __tablename__ = "template_signature_fields"

    template_id: UUID FK to templates.id with CASCADE delete
    role_name: String(100), not null - e.g., "Technician", "Supervisor"
    required: Boolean, default True
    order: Integer, not null

    Relationship: template back_populates="signature_fields"
```

Update `__init__.py` to export both new models.
  </action>
  <verify>
Run: `python -c "from app.models import TemplateInfoField, TemplateSignatureField; print('Models imported successfully')"`
  </verify>
  <done>
TemplateInfoField and TemplateSignatureField models exist with all required fields and relationships defined.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend TemplateField with JSONB columns and update Template relationships</name>
  <files>
    backend/app/models/template_field.py
    backend/app/models/template.py
  </files>
  <action>
**Modify template_field.py:**
Add JSONB columns for field configuration:
```python
from sqlalchemy.dialects.postgresql import JSONB

# Add after existing fields:
photo_config: Mapped[dict | None] = mapped_column(JSONB, nullable=True)
# Schema: {"required": bool, "min_count": int, "max_count": int, "require_gps": bool, "watermark": bool}

comment_config: Mapped[dict | None] = mapped_column(JSONB, nullable=True)
# Schema: {"enabled": bool, "required": bool}
```

**Modify template.py:**
Add relationships to new models:
```python
# Add imports for new models
# Add relationships with cascade delete and ordering:

info_fields: Mapped[list["TemplateInfoField"]] = relationship(
    "TemplateInfoField",
    back_populates="template",
    cascade="all, delete-orphan",
    order_by="TemplateInfoField.order"
)

signature_fields: Mapped[list["TemplateSignatureField"]] = relationship(
    "TemplateSignatureField",
    back_populates="template",
    cascade="all, delete-orphan",
    order_by="TemplateSignatureField.order"
)
```
  </action>
  <verify>
Run: `python -c "from app.models import Template, TemplateField; print(hasattr(TemplateField, 'photo_config'), hasattr(Template, 'info_fields'))"`
Should print: True True
  </verify>
  <done>
TemplateField has photo_config and comment_config JSONB columns. Template has info_fields and signature_fields relationships with proper cascade.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create Alembic migration for schema changes</name>
  <files>
    backend/alembic/versions/004_template_configuration.py
  </files>
  <action>
Create migration file `004_template_configuration.py`:

```python
"""Template configuration schema changes

Revision ID: 004
Revises: 003
Create Date: 2026-02-02
"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects.postgresql import JSONB

revision = "004"
down_revision = "003"

def upgrade():
    # Create template_info_fields table
    op.create_table(
        "template_info_fields",
        sa.Column("id", sa.UUID(), nullable=False, server_default=sa.text("gen_random_uuid()")),
        sa.Column("template_id", sa.UUID(), nullable=False),
        sa.Column("label", sa.String(255), nullable=False),
        sa.Column("field_type", sa.String(50), nullable=False),
        sa.Column("options", sa.Text(), nullable=True),
        sa.Column("required", sa.Boolean(), nullable=False, server_default=sa.text("true")),
        sa.Column("order", sa.Integer(), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=False, server_default=sa.text("now()")),
        sa.Column("updated_at", sa.DateTime(), nullable=False, server_default=sa.text("now()")),
        sa.PrimaryKeyConstraint("id"),
        sa.ForeignKeyConstraint(["template_id"], ["templates.id"], ondelete="CASCADE"),
    )

    # Create template_signature_fields table
    op.create_table(
        "template_signature_fields",
        sa.Column("id", sa.UUID(), nullable=False, server_default=sa.text("gen_random_uuid()")),
        sa.Column("template_id", sa.UUID(), nullable=False),
        sa.Column("role_name", sa.String(100), nullable=False),
        sa.Column("required", sa.Boolean(), nullable=False, server_default=sa.text("true")),
        sa.Column("order", sa.Integer(), nullable=False),
        sa.Column("created_at", sa.DateTime(), nullable=False, server_default=sa.text("now()")),
        sa.Column("updated_at", sa.DateTime(), nullable=False, server_default=sa.text("now()")),
        sa.PrimaryKeyConstraint("id"),
        sa.ForeignKeyConstraint(["template_id"], ["templates.id"], ondelete="CASCADE"),
    )

    # Add JSONB columns to template_fields
    op.add_column("template_fields", sa.Column("photo_config", JSONB(), nullable=True))
    op.add_column("template_fields", sa.Column("comment_config", JSONB(), nullable=True))

def downgrade():
    op.drop_column("template_fields", "comment_config")
    op.drop_column("template_fields", "photo_config")
    op.drop_table("template_signature_fields")
    op.drop_table("template_info_fields")
```

Run migration to verify: `cd backend && alembic upgrade head`
  </action>
  <verify>
Run migration: `cd backend && alembic upgrade head`
Then verify tables exist: `alembic current` should show revision 004
  </verify>
  <done>
Migration 004 exists and applies cleanly. Database has template_info_fields and template_signature_fields tables, plus photo_config and comment_config columns on template_fields.
  </done>
</task>

</tasks>

<verification>
1. All three new/modified model files exist and import without errors
2. Alembic migration 004 applies cleanly with `alembic upgrade head`
3. Database has:
   - template_info_fields table with correct columns
   - template_signature_fields table with correct columns
   - template_fields.photo_config and template_fields.comment_config JSONB columns
4. Template model has info_fields and signature_fields relationships
</verification>

<success_criteria>
- TemplateInfoField model created with label, field_type, options, required, order fields
- TemplateSignatureField model created with role_name, required, order fields
- TemplateField model extended with photo_config, comment_config JSONB columns
- Template model has relationships to info_fields and signature_fields with cascade delete
- Alembic migration 004 applies successfully
- All models import without errors from app.models
</success_criteria>

<output>
After completion, create `.planning/phases/05-template-configuration/05-01-SUMMARY.md`
</output>
