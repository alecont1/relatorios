---
phase: 05-template-configuration
plan: 05
type: execute
wave: 3
depends_on: ["05-02", "05-03"]
files_modified:
  - frontend/src/api/templates.ts
  - frontend/src/components/templates/SignatureFieldsConfigurator.tsx
  - frontend/src/components/templates/FieldConfigModal.tsx
  - frontend/src/components/templates/ChecklistSectionsView.tsx
  - frontend/src/pages/TemplateConfigPage.tsx
autonomous: true

must_haves:
  truths:
    - "Admin can add, edit, and remove signature fields with role names"
    - "Admin can click on a checklist field to open configuration modal"
    - "Field config modal shows photo settings (required, min/max, GPS, watermark)"
    - "Field config modal shows comment settings (enabled, required)"
    - "Saving field configuration persists via API"
    - "Signature field changes persist to backend"
  artifacts:
    - path: "frontend/src/components/templates/SignatureFieldsConfigurator.tsx"
      provides: "Dynamic form for signature fields management"
      min_lines: 70
    - path: "frontend/src/components/templates/FieldConfigModal.tsx"
      provides: "Modal for photo/comment configuration"
      min_lines: 80
    - path: "frontend/src/components/templates/ChecklistSectionsView.tsx"
      provides: "Display sections with clickable fields"
      min_lines: 50
  key_links:
    - from: "frontend/src/components/templates/FieldConfigModal.tsx"
      to: "PATCH /templates/fields/{id}/config API"
      via: "React Query mutation"
      pattern: "useMutation.*updateFieldConfig"
    - from: "frontend/src/components/templates/SignatureFieldsConfigurator.tsx"
      to: "Signature fields API"
      via: "React Query mutations"
      pattern: "useMutation.*signatureField"
---

<objective>
Complete frontend template configuration with signature fields management and checklist field photo/comment configuration modal.

Purpose: Enable admins to define signature requirements and configure per-field photo/comment settings for checklist items.

Output: SignatureFieldsConfigurator, FieldConfigModal, ChecklistSectionsView with field configuration, updated TemplateConfigPage.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-template-configuration/05-RESEARCH.md
@.planning/phases/05-template-configuration/05-04-SUMMARY.md

# Components to extend/integrate
@frontend/src/pages/TemplateConfigPage.tsx
@frontend/src/components/templates/AccordionSection.tsx
@frontend/src/components/templates/InfoFieldsConfigurator.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add signature fields and field config API functions</name>
  <files>
    frontend/src/api/templates.ts
  </files>
  <action>
Add API functions for signature fields and field config:

```typescript
// Signature fields API
export const getSignatureFields = (templateId: string) =>
  api.get<{ signature_fields: SignatureField[]; total: number }>(
    `/templates/${templateId}/signature-fields`
  )

export const createSignatureField = (templateId: string, data: SignatureFieldCreate) =>
  api.post<SignatureField>(`/templates/${templateId}/signature-fields`, data)

export const updateSignatureField = (
  templateId: string,
  fieldId: string,
  data: { role_name?: string; required?: boolean }
) => api.patch<SignatureField>(`/templates/${templateId}/signature-fields/${fieldId}`, data)

export const deleteSignatureField = (templateId: string, fieldId: string) =>
  api.delete(`/templates/${templateId}/signature-fields/${fieldId}`)

export const reorderSignatureFields = (templateId: string, fieldIds: string[]) =>
  api.put(`/templates/${templateId}/signature-fields/reorder`, { field_ids: fieldIds })

// Field configuration API
export interface FieldConfigUpdate {
  photo_config?: PhotoConfig
  comment_config?: CommentConfig
}

export const updateFieldConfig = (fieldId: string, data: FieldConfigUpdate) =>
  api.patch<TemplateField>(`/templates/fields/${fieldId}/config`, data)
```

Ensure TemplateField type includes photo_config and comment_config:
```typescript
export interface TemplateField {
  id: string
  label: string
  field_type: string
  options: string[] | null
  order: number
  photo_config: PhotoConfig | null
  comment_config: CommentConfig | null
}
```
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
API functions for signature fields CRUD and field config update added with proper TypeScript types.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SignatureFieldsConfigurator component</name>
  <files>
    frontend/src/components/templates/SignatureFieldsConfigurator.tsx
  </files>
  <action>
Create dynamic form for signature fields using useFieldArray:

```typescript
interface SignatureFieldsConfiguratorProps {
  templateId: string
  initialFields: SignatureField[]
  onUpdate: () => void
}
```

Features:
- useFieldArray with keyName: 'key' to manage signature fields array
- Each row: role_name input, required checkbox, delete button
- "Add Signature" button with defaults: { role_name: '', required: true }
- Common role suggestions: "Tecnico Executor", "Responsavel Tecnico", "Cliente"
- React Query useMutation for create/update/delete operations
- Toast feedback for success/error

Layout:
```
+--------------------------------------------------+
| Role Name                          Required  [X] |
| [Tecnico Executor________________] [x]       [D] |
| [Responsavel Tecnico_____________] [x]       [D] |
| [Cliente_________________________] [ ]       [D] |
|                                                  |
| [+ Add Signature Field]                   [Save] |
+--------------------------------------------------+
```

Follow same pattern as InfoFieldsConfigurator for consistency.
  </action>
  <verify>
Run: `cd frontend && npx tsc --noEmit`
  </verify>
  <done>
SignatureFieldsConfigurator uses useFieldArray for dynamic signature field management with proper key handling and API integration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create FieldConfigModal and ChecklistSectionsView</name>
  <files>
    frontend/src/components/templates/FieldConfigModal.tsx
    frontend/src/components/templates/ChecklistSectionsView.tsx
    frontend/src/pages/TemplateConfigPage.tsx
  </files>
  <action>
**Create FieldConfigModal.tsx:**

Modal for editing photo_config and comment_config of a checklist field:

```typescript
interface FieldConfigModalProps {
  field: TemplateField
  isOpen: boolean
  onClose: () => void
  onSave: () => void  // Callback to refresh data
}
```

Form fields using react-hook-form:
- Photo Settings section:
  - required: checkbox
  - min_count: number input (0-20)
  - max_count: number input (1-20)
  - require_gps: checkbox
  - watermark: checkbox
- Comment Settings section:
  - enabled: checkbox
  - required: checkbox

Validation:
- min_count <= max_count
- max_count between 1 and 20

Use existing modal/dialog pattern from project (or create simple overlay modal).
Save button calls updateFieldConfig mutation.

**Create ChecklistSectionsView.tsx:**

Display template sections with their fields:

```typescript
interface ChecklistSectionsViewProps {
  sections: TemplateSection[]
  onFieldClick: (field: TemplateField) => void
}
```

Layout:
- Map over sections, render section name as header
- Map over fields, render as clickable rows showing:
  - Field label
  - Field type badge
  - Photo config indicator (camera icon if configured)
  - Comment config indicator (chat icon if enabled)
- Click on field opens FieldConfigModal

**Update TemplateConfigPage.tsx:**

- Add signature fields query and SignatureFieldsConfigurator in Signatures accordion
- Add ChecklistSectionsView in Checklist Sections accordion
- State for selected field and modal open/close
- FieldConfigModal rendered conditionally
  </action>
  <verify>
1. Run: `cd frontend && npm run build`
2. Start app, navigate to template config page
3. Click on checklist field, verify modal opens
4. Check signature fields accordion shows configurator
  </verify>
  <done>
FieldConfigModal allows configuring photo/comment settings. ChecklistSectionsView shows sections with clickable fields. SignatureFieldsConfigurator integrated. Full template configuration UI complete.
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Signature fields accordion shows configurator with add/edit/delete
3. Checklist sections accordion shows sections with clickable fields
4. Clicking field opens FieldConfigModal
5. Photo config: required, min/max count, GPS, watermark controls work
6. Comment config: enabled, required controls work
7. Saving field config persists via API
8. Saving signature fields persists via API
</verification>

<success_criteria>
- SignatureFieldsConfigurator allows add/edit/delete signature fields
- Signature field role_name and required flag editable
- ChecklistSectionsView displays sections with fields
- Clicking field opens FieldConfigModal
- FieldConfigModal shows photo settings (required, min/max, GPS, watermark)
- FieldConfigModal shows comment settings (enabled, required)
- Validation prevents min_count > max_count
- Changes persist to backend via API calls
- Loading and error states handled appropriately
</success_criteria>

<output>
After completion, create `.planning/phases/05-template-configuration/05-05-SUMMARY.md`
</output>
