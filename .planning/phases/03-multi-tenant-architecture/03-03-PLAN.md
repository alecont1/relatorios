---
phase: 03-multi-tenant-architecture
plan: 03
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - backend/app/api/v1/routes/tenants.py
  - backend/app/api/v1/routes/__init__.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "Superadmin can create a new tenant via POST /api/v1/tenants"
    - "Superadmin can list all tenants via GET /api/v1/tenants"
    - "Superadmin can update tenant name and is_active via PATCH /api/v1/tenants/{id}"
    - "Superadmin can deactivate a tenant (setting is_active=false)"
    - "Non-superadmin users get 403 when accessing tenant endpoints"
    - "Slug uniqueness is validated on create"
  artifacts:
    - path: "backend/app/api/v1/routes/tenants.py"
      provides: "Tenant CRUD endpoints for superadmin"
      exports: ["router"]
      min_lines: 80
  key_links:
    - from: "backend/app/api/v1/routes/tenants.py"
      to: "backend/app/core/deps.py"
      via: "Depends(require_superadmin)"
      pattern: "Depends\\(require_superadmin\\)"
    - from: "backend/app/main.py"
      to: "backend/app/api/v1/routes/tenants.py"
      via: "include_router"
      pattern: "include_router.*tenants"
---

<objective>
Create superadmin-only API endpoints for tenant CRUD operations.

Purpose: Enable superadmin to create, list, update, and deactivate tenant organizations (TNNT-01).
Output: Tenant management API with full CRUD, accessible only to superadmin users.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-tenant-architecture/03-RESEARCH.md
@.planning/phases/03-multi-tenant-architecture/03-01-SUMMARY.md
@.planning/phases/03-multi-tenant-architecture/03-02-SUMMARY.md
@backend/app/api/v1/routes/users.py
@backend/app/core/deps.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenant CRUD endpoints</name>
  <files>backend/app/api/v1/routes/tenants.py</files>
  <action>
Create new file with the following endpoints, all protected by require_superadmin:

```python
"""
Tenant CRUD endpoints for superadmin.

This module provides:
- POST /tenants/ - Create tenant (superadmin only)
- GET /tenants/ - List all tenants with pagination
- GET /tenants/{tenant_id} - Get specific tenant
- PATCH /tenants/{tenant_id} - Update tenant (name, is_active only)

Note: Slug is immutable after creation to avoid R2 object key migrations.
"""

from typing import Annotated
from uuid import UUID

from fastapi import APIRouter, Depends, HTTPException, status, Query
from sqlalchemy import select, func
from sqlalchemy.ext.asyncio import AsyncSession

from app.core.database import get_db
from app.core.deps import require_superadmin
from app.models.tenant import Tenant
from app.models.user import User
from app.schemas.tenant import (
    TenantCreate,
    TenantUpdate,
    TenantResponse,
    TenantListResponse,
)

router = APIRouter(prefix="/tenants", tags=["tenants"])


@router.post("/", response_model=TenantResponse, status_code=status.HTTP_201_CREATED)
async def create_tenant(
    tenant_data: TenantCreate,
    current_user: Annotated[User, Depends(require_superadmin)],
    db: AsyncSession = Depends(get_db),
):
    """
    Create a new tenant organization.

    Slug must be unique and will be immutable after creation.
    All new tenants are created as active (is_active=True).
    """
    # Check slug uniqueness
    result = await db.execute(
        select(Tenant).where(Tenant.slug == tenant_data.slug)
    )
    if result.scalar_one_or_none():
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Slug ja existe",
        )

    tenant = Tenant(
        name=tenant_data.name,
        slug=tenant_data.slug,
    )
    db.add(tenant)
    await db.commit()
    await db.refresh(tenant)

    return TenantResponse.model_validate(tenant)


@router.get("/", response_model=TenantListResponse)
async def list_tenants(
    current_user: Annotated[User, Depends(require_superadmin)],
    db: AsyncSession = Depends(get_db),
    skip: int = Query(0, ge=0),
    limit: int = Query(50, ge=1, le=100),
    include_inactive: bool = Query(False),
):
    """
    List all tenant organizations.

    By default shows only active tenants.
    Use include_inactive=true to see all tenants.
    """
    query = select(Tenant)

    if not include_inactive:
        query = query.where(Tenant.is_active == True)

    # Get total count
    count_query = select(func.count()).select_from(query.subquery())
    total = await db.scalar(count_query)

    # Get paginated results
    query = query.offset(skip).limit(limit).order_by(Tenant.created_at.desc())
    result = await db.execute(query)
    tenants = result.scalars().all()

    return TenantListResponse(
        tenants=[TenantResponse.model_validate(t) for t in tenants],
        total=total or 0,
    )


@router.get("/{tenant_id}", response_model=TenantResponse)
async def get_tenant(
    tenant_id: UUID,
    current_user: Annotated[User, Depends(require_superadmin)],
    db: AsyncSession = Depends(get_db),
):
    """Get a specific tenant by ID."""
    result = await db.execute(select(Tenant).where(Tenant.id == tenant_id))
    tenant = result.scalar_one_or_none()

    if not tenant:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Tenant nao encontrado",
        )

    return TenantResponse.model_validate(tenant)


@router.patch("/{tenant_id}", response_model=TenantResponse)
async def update_tenant(
    tenant_id: UUID,
    tenant_data: TenantUpdate,
    current_user: Annotated[User, Depends(require_superadmin)],
    db: AsyncSession = Depends(get_db),
):
    """
    Update a tenant organization.

    Only name and is_active can be updated.
    Slug is immutable to preserve R2 object key consistency.
    """
    result = await db.execute(select(Tenant).where(Tenant.id == tenant_id))
    tenant = result.scalar_one_or_none()

    if not tenant:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Tenant nao encontrado",
        )

    # Update allowed fields only
    if tenant_data.name is not None:
        tenant.name = tenant_data.name
    if tenant_data.is_active is not None:
        tenant.is_active = tenant_data.is_active

    await db.commit()
    await db.refresh(tenant)

    return TenantResponse.model_validate(tenant)
```
  </action>
  <verify>python -c "from app.api.v1.routes.tenants import router; print(f'{len(router.routes)} routes')" should show 4 routes</verify>
  <done>Tenant CRUD endpoints exist with superadmin protection</done>
</task>

<task type="auto">
  <name>Task 2: Register tenant routes in main app</name>
  <files>backend/app/api/v1/routes/__init__.py, backend/app/main.py</files>
  <action>
1. Update backend/app/api/v1/routes/__init__.py to import tenants router:
   Add: `from app.api.v1.routes.tenants import router as tenants_router`

2. Update backend/app/main.py to include the tenants router:
   Add after existing route includes:
   ```python
   from app.api.v1.routes.tenants import router as tenants_router
   app.include_router(tenants_router, prefix="/api/v1")
   ```

Ensure tenants router is included at /api/v1/tenants path.
  </action>
  <verify>Run backend server and check /docs shows /api/v1/tenants endpoints</verify>
  <done>Tenant routes are accessible at /api/v1/tenants</done>
</task>

</tasks>

<verification>
1. Run `cd backend && python -c "from app.api.v1.routes.tenants import router; print('OK')"` - should succeed
2. Check main.py includes tenants router
3. All 4 endpoints (POST, GET list, GET single, PATCH) exist
4. All endpoints use Depends(require_superadmin)
</verification>

<success_criteria>
- POST /api/v1/tenants creates new tenant with unique slug validation
- GET /api/v1/tenants lists tenants with pagination and inactive filter
- GET /api/v1/tenants/{id} returns single tenant
- PATCH /api/v1/tenants/{id} updates name and is_active only
- All endpoints return 403 for non-superadmin users
- Error messages are in Portuguese
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-tenant-architecture/03-03-SUMMARY.md`
</output>
