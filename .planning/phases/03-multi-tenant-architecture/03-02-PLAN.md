---
phase: 03-multi-tenant-architecture
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/app/core/deps.py
autonomous: true

must_haves:
  truths:
    - "require_superadmin dependency validates user role is superadmin"
    - "get_tenant_filter dependency returns current user's tenant_id"
    - "Non-superadmin users get 403 when accessing superadmin-only routes"
    - "Tenant isolation is enforced via dependency injection"
  artifacts:
    - path: "backend/app/core/deps.py"
      provides: "Auth dependencies for tenant isolation and superadmin validation"
      exports: ["require_superadmin", "get_tenant_filter"]
  key_links:
    - from: "backend/app/core/deps.py"
      to: "backend/app/api/v1/routes/*.py"
      via: "FastAPI Depends injection"
      pattern: "Depends\\(require_superadmin\\)"
---

<objective>
Add FastAPI dependencies for tenant data isolation and superadmin-only route protection.

Purpose: Enable automatic tenant filtering for all queries (TNNT-02) and superadmin validation for tenant management (TNNT-01).
Output: Two new dependencies in deps.py: require_superadmin and get_tenant_filter.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-tenant-architecture/03-RESEARCH.md
@backend/app/core/deps.py
@backend/app/api/v1/routes/users.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add require_superadmin dependency</name>
  <files>backend/app/core/deps.py</files>
  <action>
Add a new dependency function `require_superadmin` to deps.py:

```python
async def require_superadmin(
    current_user: Annotated[User, Depends(get_current_user)]
) -> User:
    """
    Dependency for superadmin-only routes.

    Use this for tenant management endpoints that should only
    be accessible by superadmin users.

    Args:
        current_user: Authenticated user from JWT

    Returns:
        User if superadmin

    Raises:
        HTTPException 403: If user is not superadmin
    """
    if current_user.role != "superadmin":
        raise HTTPException(
            status_code=status.HTTP_403_FORBIDDEN,
            detail="Acesso negado - apenas superadmin"
        )
    return current_user
```

This is separate from require_role because superadmin has special meaning for cross-tenant access.
  </action>
  <verify>python -c "from app.core.deps import require_superadmin; print('OK')" should succeed</verify>
  <done>require_superadmin dependency exists and raises 403 for non-superadmin</done>
</task>

<task type="auto">
  <name>Task 2: Add get_tenant_filter dependency</name>
  <files>backend/app/core/deps.py</files>
  <action>
Add a new dependency function `get_tenant_filter` to deps.py:

```python
import uuid

async def get_tenant_filter(
    current_user: Annotated[User, Depends(get_current_user)]
) -> uuid.UUID:
    """
    Return current user's tenant_id for query filtering.

    Use this dependency in routes to automatically scope database
    queries to the current user's tenant. Ensures tenant isolation
    (TNNT-02) without forgetting to add WHERE clauses.

    Usage in routes:
        @router.get("/templates")
        async def list_templates(
            tenant_id: Annotated[uuid.UUID, Depends(get_tenant_filter)],
            db: AsyncSession = Depends(get_db),
        ):
            query = select(Template).where(Template.tenant_id == tenant_id)
            ...

    Args:
        current_user: Authenticated user from JWT

    Returns:
        UUID of current user's tenant
    """
    return current_user.tenant_id
```

Add `import uuid` at the top of the file if not already imported.

This pattern makes tenant filtering explicit and prevents accidental cross-tenant data leakage.
  </action>
  <verify>python -c "from app.core.deps import get_tenant_filter; print('OK')" should succeed</verify>
  <done>get_tenant_filter dependency exists and returns user's tenant_id</done>
</task>

</tasks>

<verification>
1. Run `cd backend && python -c "from app.core.deps import require_superadmin, get_tenant_filter; print('Both imports OK')"` - should succeed
2. Check deps.py has both functions with proper docstrings
3. Both dependencies use Depends(get_current_user) for user extraction
</verification>

<success_criteria>
- require_superadmin raises 403 for non-superadmin roles
- get_tenant_filter returns UUID (user's tenant_id)
- Both functions have docstrings with usage examples
- Error messages are in Portuguese
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-tenant-architecture/03-02-SUMMARY.md`
</output>
