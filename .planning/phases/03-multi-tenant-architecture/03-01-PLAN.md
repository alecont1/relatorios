---
phase: 03-multi-tenant-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - backend/alembic/versions/20260131_002_tenant_branding.py
  - backend/app/models/tenant.py
  - backend/app/schemas/tenant.py
autonomous: true

must_haves:
  truths:
    - "Tenant model has branding color fields (primary, secondary, accent)"
    - "Tenant model has logo key fields (primary, secondary)"
    - "Tenant model has contact info fields (address, phone, email, website)"
    - "Alembic migration runs successfully without errors"
  artifacts:
    - path: "backend/alembic/versions/20260131_002_tenant_branding.py"
      provides: "Database migration for tenant branding fields"
      contains: "brand_color_primary"
    - path: "backend/app/models/tenant.py"
      provides: "Tenant model with branding and contact fields"
      contains: "logo_primary_key"
    - path: "backend/app/schemas/tenant.py"
      provides: "Pydantic schemas for tenant CRUD operations"
      exports: ["TenantCreate", "TenantUpdate", "TenantResponse", "TenantBrandingUpdate"]
  key_links:
    - from: "backend/alembic/versions/20260131_002_tenant_branding.py"
      to: "tenants table"
      via: "Alembic add_column"
      pattern: "add_column.*tenants"
---

<objective>
Extend the Tenant model with branding and contact information fields, and create the database migration.

Purpose: Enable tenant customization with logos, brand colors, and contact details required for TNNT-03, TNNT-04, TNNT-05.
Output: Extended Tenant model, Pydantic schemas, and Alembic migration file.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-tenant-architecture/03-RESEARCH.md
@backend/app/models/tenant.py
@backend/app/models/base.py
@backend/alembic/versions/20260124_001_initial_schema.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Tenant model with branding and contact fields</name>
  <files>backend/app/models/tenant.py</files>
  <action>
Add the following fields to the Tenant model class:

Branding fields (for TNNT-03 and TNNT-04):
- logo_primary_key: Optional[str] = mapped_column(String(500), nullable=True) - R2 object key for primary logo
- logo_secondary_key: Optional[str] = mapped_column(String(500), nullable=True) - R2 object key for secondary logo
- brand_color_primary: Optional[str] = mapped_column(String(7), nullable=True) - Hex color #RRGGBB
- brand_color_secondary: Optional[str] = mapped_column(String(7), nullable=True) - Hex color #RRGGBB
- brand_color_accent: Optional[str] = mapped_column(String(7), nullable=True) - Hex color #RRGGBB

Contact fields (for TNNT-05):
- contact_address: Optional[str] = mapped_column(String(500), nullable=True)
- contact_phone: Optional[str] = mapped_column(String(50), nullable=True)
- contact_email: Optional[str] = mapped_column(String(255), nullable=True)
- contact_website: Optional[str] = mapped_column(String(255), nullable=True)

Import Optional from typing. All fields are nullable with default None.
  </action>
  <verify>python -c "from app.models.tenant import Tenant; t = Tenant.__table__.columns; print([c.name for c in t])" in backend directory should list all new columns</verify>
  <done>Tenant model contains all branding and contact fields</done>
</task>

<task type="auto">
  <name>Task 2: Create Pydantic schemas for tenant operations</name>
  <files>backend/app/schemas/tenant.py</files>
  <action>
Create new file backend/app/schemas/tenant.py with the following schemas:

```python
"""
Tenant schemas for API request/response validation.
"""

import re
from datetime import datetime
from uuid import UUID

from pydantic import BaseModel, EmailStr, Field, field_validator


class TenantBase(BaseModel):
    """Base tenant fields."""
    name: str = Field(min_length=2, max_length=255)
    slug: str = Field(min_length=2, max_length=100, pattern="^[a-z0-9-]+$")


class TenantCreate(TenantBase):
    """Schema for creating a new tenant (superadmin only)."""
    pass


class TenantUpdate(BaseModel):
    """Schema for updating tenant (superadmin only)."""
    name: str | None = Field(default=None, min_length=2, max_length=255)
    is_active: bool | None = None
    # Note: slug is immutable after creation


class TenantBrandingUpdate(BaseModel):
    """Schema for updating tenant branding (admin/superadmin)."""
    # Logo keys (set after upload to R2)
    logo_primary_key: str | None = Field(default=None, max_length=500)
    logo_secondary_key: str | None = Field(default=None, max_length=500)

    # Brand colors (hex format)
    brand_color_primary: str | None = Field(default=None, max_length=7)
    brand_color_secondary: str | None = Field(default=None, max_length=7)
    brand_color_accent: str | None = Field(default=None, max_length=7)

    # Contact info
    contact_address: str | None = Field(default=None, max_length=500)
    contact_phone: str | None = Field(default=None, max_length=50)
    contact_email: EmailStr | None = None
    contact_website: str | None = Field(default=None, max_length=255)

    @field_validator("brand_color_primary", "brand_color_secondary", "brand_color_accent")
    @classmethod
    def validate_hex_color(cls, v: str | None) -> str | None:
        """Validate hex color format #RRGGBB."""
        if v is None:
            return v
        if not re.match(r"^#[0-9A-Fa-f]{6}$", v):
            raise ValueError("Cor deve estar no formato #RRGGBB")
        return v.upper()  # Normalize to uppercase


class TenantResponse(BaseModel):
    """Tenant data returned in API responses."""
    id: UUID
    name: str
    slug: str
    is_active: bool

    # Branding
    logo_primary_key: str | None
    logo_secondary_key: str | None
    brand_color_primary: str | None
    brand_color_secondary: str | None
    brand_color_accent: str | None

    # Contact
    contact_address: str | None
    contact_phone: str | None
    contact_email: str | None
    contact_website: str | None

    created_at: datetime
    updated_at: datetime

    model_config = {"from_attributes": True}


class TenantListResponse(BaseModel):
    """Paginated list of tenants."""
    tenants: list[TenantResponse]
    total: int
```

Also update backend/app/schemas/__init__.py to export the new schemas.
  </action>
  <verify>python -c "from app.schemas.tenant import TenantCreate, TenantUpdate, TenantResponse, TenantBrandingUpdate; print('OK')" should succeed</verify>
  <done>Tenant Pydantic schemas exist with all branding and contact fields</done>
</task>

<task type="auto">
  <name>Task 3: Create Alembic migration for tenant branding fields</name>
  <files>backend/alembic/versions/20260131_002_tenant_branding.py</files>
  <action>
Create new migration file with these specifications:

- revision: '002'
- down_revision: '001'
- Add 9 new columns to tenants table using op.add_column():
  - logo_primary_key (String 500, nullable)
  - logo_secondary_key (String 500, nullable)
  - brand_color_primary (String 7, nullable)
  - brand_color_secondary (String 7, nullable)
  - brand_color_accent (String 7, nullable)
  - contact_address (String 500, nullable)
  - contact_phone (String 50, nullable)
  - contact_email (String 255, nullable)
  - contact_website (String 255, nullable)

Migration should be reversible (implement downgrade to drop columns).

Use this pattern:
```python
op.add_column('tenants', sa.Column('logo_primary_key', sa.String(500), nullable=True))
```

Downgrade should drop columns in reverse order.
  </action>
  <verify>cd backend && alembic check should show no pending operations (after model changes match migration)</verify>
  <done>Migration file exists and is syntactically valid</done>
</task>

</tasks>

<verification>
1. Run `cd backend && python -c "from app.models.tenant import Tenant; print('Model OK')"` - should succeed
2. Run `cd backend && python -c "from app.schemas.tenant import TenantResponse; print('Schemas OK')"` - should succeed
3. Run `cd backend && alembic history` - should show migration 002 after 001
4. Verify all 9 new fields are in Tenant model and schemas
</verification>

<success_criteria>
- Tenant model has 9 new fields (5 branding + 4 contact)
- TenantCreate, TenantUpdate, TenantBrandingUpdate, TenantResponse schemas exist
- Hex color validation works for brand colors
- Alembic migration 002 is valid and references migration 001
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-tenant-architecture/03-01-SUMMARY.md`
</output>
