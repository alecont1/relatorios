---
phase: 03-multi-tenant-architecture
plan: 04
type: execute
wave: 2
depends_on: ["03-01", "03-02"]
files_modified:
  - backend/app/api/v1/routes/tenant_settings.py
  - backend/app/main.py
autonomous: true

must_haves:
  truths:
    - "Admin can get their tenant's branding settings via GET /api/v1/tenant-settings/branding"
    - "Admin can update brand colors via PATCH /api/v1/tenant-settings/branding"
    - "Admin can update contact info via PATCH /api/v1/tenant-settings/branding"
    - "Admin can generate presigned URL for logo upload via POST /api/v1/tenant-settings/logo/upload-url"
    - "Admin can confirm logo upload via POST /api/v1/tenant-settings/logo/confirm"
    - "Logo URLs are scoped to tenant's R2 prefix"
    - "Tenant isolation is enforced via get_tenant_filter dependency (TNNT-02)"
  artifacts:
    - path: "backend/app/api/v1/routes/tenant_settings.py"
      provides: "Tenant branding settings endpoints for admin"
      exports: ["router"]
      min_lines: 100
  key_links:
    - from: "backend/app/api/v1/routes/tenant_settings.py"
      to: "backend/app/services/storage.py"
      via: "get_storage_service()"
      pattern: "get_storage_service"
    - from: "backend/app/api/v1/routes/tenant_settings.py"
      to: "backend/app/core/deps.py"
      via: "Depends(require_role)"
      pattern: 'require_role\\("admin"'
    - from: "backend/app/api/v1/routes/tenant_settings.py"
      to: "backend/app/core/deps.py"
      via: "Depends(get_tenant_filter)"
      pattern: "Depends\\(get_tenant_filter\\)"
---

<objective>
Create API endpoints for tenant admins to manage their organization's branding settings.

Purpose: Enable tenant admins to configure logo images, brand colors, and contact information (TNNT-03, TNNT-04, TNNT-05).
Output: Tenant settings API with branding CRUD and logo upload endpoints.
</objective>

<execution_context>
@C:\Users\xande\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\xande\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-multi-tenant-architecture/03-RESEARCH.md
@.planning/phases/03-multi-tenant-architecture/03-01-SUMMARY.md
@.planning/phases/03-multi-tenant-architecture/03-02-SUMMARY.md
@backend/app/services/storage.py
@backend/app/api/v1/routes/users.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create tenant settings endpoints</name>
  <files>backend/app/api/v1/routes/tenant_settings.py</files>
  <action>
Create new file with branding management endpoints:

```python
"""
Tenant settings endpoints for admin branding configuration.

This module provides:
- GET /tenant-settings/branding - Get current tenant branding
- PATCH /tenant-settings/branding - Update branding (colors, contact)
- POST /tenant-settings/logo/upload-url - Generate presigned URL for logo upload
- POST /tenant-settings/logo/confirm - Confirm logo upload and save key

Accessible by admin and superadmin roles.
"""

from typing import Annotated, Literal

from fastapi import APIRouter, Depends, HTTPException, status, Query
from pydantic import BaseModel, Field
from sqlalchemy import select
from sqlalchemy.ext.asyncio import AsyncSession

from app.core.database import get_db
from app.core.deps import require_role
from app.models.tenant import Tenant
from app.models.user import User
from app.schemas.tenant import TenantBrandingUpdate, TenantResponse
from app.services.storage import get_storage_service

router = APIRouter(prefix="/tenant-settings", tags=["tenant-settings"])


class LogoUploadRequest(BaseModel):
    """Request for generating logo upload URL."""
    logo_type: Literal["primary", "secondary"]
    filename: str = Field(min_length=1, max_length=255)


class LogoUploadResponse(BaseModel):
    """Response with presigned upload URL."""
    upload_url: str
    object_key: str


class LogoConfirmRequest(BaseModel):
    """Request to confirm logo upload."""
    logo_type: Literal["primary", "secondary"]
    object_key: str = Field(max_length=500)


@router.get("/branding", response_model=TenantResponse)
async def get_tenant_branding(
    current_user: Annotated[User, Depends(require_role("admin", "superadmin"))],
    db: AsyncSession = Depends(get_db),
):
    """
    Get current tenant's branding settings.

    Returns all tenant fields including logos, colors, and contact info.
    """
    result = await db.execute(
        select(Tenant).where(Tenant.id == current_user.tenant_id)
    )
    tenant = result.scalar_one_or_none()

    if not tenant:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Tenant nao encontrado",
        )

    return TenantResponse.model_validate(tenant)


@router.patch("/branding", response_model=TenantResponse)
async def update_tenant_branding(
    branding_data: TenantBrandingUpdate,
    current_user: Annotated[User, Depends(require_role("admin", "superadmin"))],
    db: AsyncSession = Depends(get_db),
):
    """
    Update tenant branding settings.

    Can update brand colors and contact information.
    For logo updates, use the /logo/upload-url and /logo/confirm endpoints.
    """
    result = await db.execute(
        select(Tenant).where(Tenant.id == current_user.tenant_id)
    )
    tenant = result.scalar_one_or_none()

    if not tenant:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Tenant nao encontrado",
        )

    # Update branding fields (exclude_unset=True skips None fields)
    update_data = branding_data.model_dump(exclude_unset=True)
    for field, value in update_data.items():
        setattr(tenant, field, value)

    await db.commit()
    await db.refresh(tenant)

    return TenantResponse.model_validate(tenant)


@router.post("/logo/upload-url", response_model=LogoUploadResponse)
async def generate_logo_upload_url(
    request: LogoUploadRequest,
    current_user: Annotated[User, Depends(require_role("admin", "superadmin"))],
):
    """
    Generate presigned URL for logo upload to R2.

    Client uploads directly to this URL, then calls /logo/confirm
    to save the object key to the tenant record.
    """
    # Validate file extension
    ext = request.filename.rsplit(".", 1)[-1].lower() if "." in request.filename else ""
    allowed_extensions = ["png", "jpg", "jpeg", "svg", "webp"]

    if ext not in allowed_extensions:
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail=f"Formato invalido. Use: {', '.join(allowed_extensions)}",
        )

    # Generate tenant-scoped key
    object_key = f"{current_user.tenant_id}/branding/{request.logo_type}-logo.{ext}"

    # Get presigned URL from storage service
    storage = get_storage_service()
    content_type = "image/svg+xml" if ext == "svg" else f"image/{ext}"

    url = storage._client.generate_presigned_url(
        "put_object",
        Params={
            "Bucket": storage._bucket,
            "Key": object_key,
            "ContentType": content_type,
        },
        ExpiresIn=3600,  # 1 hour
    )

    return LogoUploadResponse(upload_url=url, object_key=object_key)


@router.post("/logo/confirm", response_model=TenantResponse)
async def confirm_logo_upload(
    request: LogoConfirmRequest,
    current_user: Annotated[User, Depends(require_role("admin", "superadmin"))],
    db: AsyncSession = Depends(get_db),
):
    """
    Confirm logo upload and save object key to tenant.

    Called after successful upload to R2 to update the tenant record
    with the new logo key.
    """
    result = await db.execute(
        select(Tenant).where(Tenant.id == current_user.tenant_id)
    )
    tenant = result.scalar_one_or_none()

    if not tenant:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Tenant nao encontrado",
        )

    # Validate object key belongs to this tenant
    expected_prefix = f"{current_user.tenant_id}/branding/"
    if not request.object_key.startswith(expected_prefix):
        raise HTTPException(
            status_code=status.HTTP_400_BAD_REQUEST,
            detail="Chave de objeto invalida para este tenant",
        )

    # Update logo key
    if request.logo_type == "primary":
        tenant.logo_primary_key = request.object_key
    else:
        tenant.logo_secondary_key = request.object_key

    await db.commit()
    await db.refresh(tenant)

    return TenantResponse.model_validate(tenant)
```
  </action>
  <verify>python -c "from app.api.v1.routes.tenant_settings import router; print(f'{len(router.routes)} routes')" should show 4 routes</verify>
  <done>Tenant settings endpoints exist for branding management</done>
</task>

<task type="auto">
  <name>Task 2: Register tenant settings routes in main app</name>
  <files>backend/app/main.py</files>
  <action>
Update backend/app/main.py to include the tenant_settings router:

Add import:
```python
from app.api.v1.routes.tenant_settings import router as tenant_settings_router
```

Add route registration after other routers:
```python
app.include_router(tenant_settings_router, prefix="/api/v1")
```

Ensure tenant_settings router is included at /api/v1/tenant-settings path.
  </action>
  <verify>Run backend server and check /docs shows /api/v1/tenant-settings endpoints</verify>
  <done>Tenant settings routes are accessible at /api/v1/tenant-settings</done>
</task>

<task type="auto">
  <name>Task 3: Demonstrate tenant filtering in sample query</name>
  <files>backend/app/api/v1/routes/tenant_settings.py</files>
  <action>
Add a demonstration of get_tenant_filter usage in the GET /branding endpoint to showcase tenant isolation (TNNT-02).

Update the get_tenant_branding function to use get_tenant_filter:

```python
from app.core.deps import require_role, get_tenant_filter

@router.get("/branding", response_model=TenantResponse)
async def get_tenant_branding(
    current_user: Annotated[User, Depends(require_role("admin", "superadmin"))],
    tenant_id: Annotated[UUID, Depends(get_tenant_filter)],  # Add this line
    db: AsyncSession = Depends(get_db),
):
    """
    Get current tenant's branding settings.

    Returns all tenant fields including logos, colors, and contact info.
    Uses get_tenant_filter dependency for automatic tenant isolation.
    """
    result = await db.execute(
        select(Tenant).where(Tenant.id == tenant_id)  # Use tenant_id from dependency
    )
    tenant = result.scalar_one_or_none()

    if not tenant:
        raise HTTPException(
            status_code=status.HTTP_404_NOT_FOUND,
            detail="Tenant nao encontrado",
        )

    return TenantResponse.model_validate(tenant)
```

Update PATCH /branding endpoint similarly:
```python
@router.patch("/branding", response_model=TenantResponse)
async def update_tenant_branding(
    branding_data: TenantBrandingUpdate,
    current_user: Annotated[User, Depends(require_role("admin", "superadmin"))],
    tenant_id: Annotated[UUID, Depends(get_tenant_filter)],  # Add this line
    db: AsyncSession = Depends(get_db),
):
    """
    Update tenant branding settings.

    Can update brand colors and contact information.
    For logo updates, use the /logo/upload-url and /logo/confirm endpoints.
    Uses get_tenant_filter dependency for automatic tenant isolation.
    """
    result = await db.execute(
        select(Tenant).where(Tenant.id == tenant_id)  # Use tenant_id from dependency
    )
    # ... rest of function unchanged
```

This demonstrates proper tenant filtering using the get_tenant_filter dependency from Plan 03-02.
  </action>
  <verify>python -c "from app.api.v1.routes.tenant_settings import router; import inspect; sig = inspect.signature(router.routes[0].endpoint); print('tenant_id' in sig.parameters)" should show True</verify>
  <done>Tenant settings endpoints demonstrate get_tenant_filter usage for TNNT-02</done>
</task>

</tasks>

<verification>
1. Run `cd backend && python -c "from app.api.v1.routes.tenant_settings import router; print('OK')"` - should succeed
2. Check main.py includes tenant_settings router
3. All 4 endpoints exist (GET branding, PATCH branding, POST upload-url, POST confirm)
4. All endpoints use Depends(require_role("admin", "superadmin"))
5. GET and PATCH branding endpoints use Depends(get_tenant_filter) for tenant isolation
6. Logo upload validates file extension
7. Object key validation prevents cross-tenant access
</verification>

<success_criteria>
- GET /api/v1/tenant-settings/branding returns tenant branding data
- PATCH /api/v1/tenant-settings/branding updates colors and contact info
- POST /api/v1/tenant-settings/logo/upload-url generates presigned URL for valid file types
- POST /api/v1/tenant-settings/logo/confirm saves logo key after validation
- Only admin and superadmin can access these endpoints
- Error messages are in Portuguese
</success_criteria>

<output>
After completion, create `.planning/phases/03-multi-tenant-architecture/03-04-SUMMARY.md`
</output>
